---
title: "WiRnorming"
author: "Stuart Rosen"
date: "10/06/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Four studies are available with relevant data 
* SC = Cooper 2011 BSc Speech Sciences UCL (1)
* RL = Lancaster 2009 IBSc UCL (2)
* HR = Roe 2008 BSc Audiology UCL (3)
* GY = control listeners from Guy's study (4)

### Here are boxplots for the age ranges in each study.
#### Note that the boxplots can be misleading because of bimodal distributions

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

require(plyr)
require(car)
require(nlstools)
require(tidyverse)


getOriginalData <- function(){
  d<-read.csv("WiR-TDx4_v1.csv",header=T)
  d$study <- as.factor(d$study)
  d$study <- revalue(d$study, c("1"="SC", "2"="RL", "3"="GY", "4"="HR"))
  return(d)
}
d <- getOriginalData ()

ggplot(d, aes(study, age, colour=study)) +
  geom_boxplot(position=position_dodge(0.8), outlier.shape = NA) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2))

```

### Here is the essential raw data before any data removals or adjustments

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
ggplot(d, aes(age, SRT, group=study, color=study)) + geom_point() 

```


### Are the studies consistent in the SRTs for children aged 11 and up?
<font size="4">Given the evidence that SRTs do not appear to change after age 11, we compare SRTs across the 4 studies for that group of older children. Below are boxplots of the z-scored SRTs by group.  Note first that only for SC are all children older than 11, and with a tight range of ages, so it is the only study in which it makes sense to calculate z-scores for SRTs without regard to age. This shows there is a low outlier in SRT (-17.2 dB) in the SC group. This was deleted as being 3 s.d.'s from the mean, although the actual z-score was -2.987, so essentially 3.</font>

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
d$zSRT <- ave(d$SRT, d$study, FUN=scale)
ggplot(d, aes(study, zSRT, colour=study)) +
  geom_boxplot(position=position_dodge(0.8), outlier.shape = NA) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2)) +
  scale_y_continuous(breaks=seq(-3,3))

# delete SC lowest value as < -3 s.d. from the mean = -17.13
d <- d[!d$SRT< -16,]
#
```

#### On the basis of the notion that SRTs do not improve much after age 11, boxplots were made of the SRTs from the 4 studies for all listeners older than that age:

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

dCmp <-   d[d$age>=11,]

ggplot(dCmp, aes(study, SRT,colour=study)) + geom_boxplot() + geom_point(position = position_jitterdodge(jitter.width = 0.2))
```

#### A one-way ANOVA with a follow-up Tukey post-hoc test shows that the mean SRTs are not the same in the 4 groups (f (3, 77) = 9.203, p = 2.825e-05).  The SRTs for SC are significantly lower than from RL and GY (both ps < 0.003). SC and HR are not significantly different (p = 0.152) even though the absolute difference in means is very similar to the other two groups. 

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

m3 <- lm(SRT ~ study, data = dCmp)
summary(m3)
anova(m3)

m3a <- aov(SRT ~ study, data = dCmp)
summary(m3a)
TukeyHSD(m3a)

# break studies into to -- SC vs the rest
dCmp$g2 <- dplyr::recode(dCmp$study, RL = 'RL+GY+HR', GY = 'RL+GY+HR', HR = 'RL+GY+HR')
dCmpu <- ddply(dCmp, .(g2), summarise, mean=mean(SRT), min=min(SRT), max=max(SRT), n=length(SRT))
dCmpu

SRTadj <- mean(dCmp$SRT[dCmp$study!="SC"]) - mean(dCmp$SRT[d$study=="SC"]) 
noquote(paste('Aggregating RL+GY+HR into one group shows a mean difference of ', round(SRTadj,1), ' dB between this group of 3 and SC. ', sep=''))

```

#### As SC only had participants aged 11.6-16.5 years (in secondary school), it seemed undesirable to leave the SRTs as is, because this overall effect on model fits would not be distributed across the age range, particularly for younger children where developmental changes are obvious. Therefore, SRTs for the SC study were all adjusted upwards by 2.4 dB, after which a one-way ANOVA confirmed no differences across the groups (f (3,77) = 0.301, p = 0.825).

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

# adjust SRTs from the SC study by the difference
d$SRTx <- d$SRT + as.numeric(d$study=="SC")*SRTadj

dCmp <-   d[d$age>=11,]
ggplot(dCmp, aes(study, SRTx)) + geom_boxplot()

mg4 <- lm(SRTx ~ study, data = dCmp)
summary(mg4)

```

### Main analysis: Fit a segmented regression 
<font size="4"> We intially fit two models. One was a segmented, or broken stick regression, in which the model consists of two straight lines which meet at a breakpoint.  The other model was an asymptotic regression model. </font>
```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

# broken stick regression
TwoLinesFCT <- function(x, slope1, slope2, int1, brk) {
  (x<=brk)*(slope1 * x + int1) + (x>brk)*(slope2 * x + brk*(slope1-slope2)+int1) 
}
# saturated model
mSAT <- nls(SRTx ~ TwoLinesFCT(age, slope1, slope2, int1, brk),
                start=list(slope1=-1.4, slope2=0.01, int1=4, brk=10),
                data=d,
                trace = FALSE)
summary(mSAT)


mASYMP <- nls(SRTx ~ TwoLinesFCT(age, slope1, 0, int1, brk),
              start=list(slope1=-1, int1=0, brk=10),
              data=d,
              trace = FALSE)
summary(mASYMP)

# slope of upper line ~ 0, p=0.58
anova(mSAT, mASYMP)
m <- mASYMP


```

### Main analysis: Fit an asymptotic regression model

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

asympRegrFCT <- function(age, b1, b2, b3) {
  b1 + b2 * exp(b3 * age)
}
mHyp <- nls(SRTx ~ asympRegrFCT(age, b1, b2, b3),
            start=list(b1=-10, b2=40, b3=-.4),
            data=d,
            trace = FALSE)
summary(mHyp)

Hyp <- function(age) {asympRegrFCT(age, 
        as.numeric(coefficients(mHyp)[1]), as.numeric(coefficients(mHyp)[2]), as.numeric(coefficients(mHyp)[3]))}


```


### Main analysis: Compare the two model fits
#### The overall fits of the two models were very similar with the broken stick model a slightly better fit with a residual standard error of 2.34 compared to 2.40 on 114 degrees of freedom (as both models have the same number of estimated parameters).  It is also more intuitively appealing.  

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

# ensure the breakpoint is plotted by adding it to the vector
nAge = sort(c(seq(4, 25, 1),as.numeric(coefficients(m)[3])))
nData <- data.frame(age = nAge)
fitted <- predict(m, newdata=nData, re.form=NA, type="response")

TwoLines <- function(age) {TwoLinesFCT(age, 
      as.numeric(coefficients(m)[1]), 0, as.numeric(coefficients(m)[2]), as.numeric(coefficients(m)[3]))}
p <- ggplot(d, aes(age, SRTx, group=study, color=study)) + geom_point() 
p <- p + stat_function(fun = TwoLines, color="black")
p + stat_function(fun = TwoLines, color="black") + stat_function(fun = Hyp, color="black") 


```

#### The standardised residuals look sufficiently unstructured. Note that the vertical line at left arises because the model predicts the same SRT for everyone over the age of 9.9 years.

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

plot(nlsResiduals(m))
# summary(m)

```

#### It could be that the variability in the younger children would be greater than that of the older, making suspect a simple calculation of a standardised residual. However, although the following graph shows a hint of that (in that the youngest children seem to be more dispersed), it essentially looks pretty good:

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
resASYMP <- resid(m)
fitASYMP <- fitted(m)
sdRES <- sd(resASYMP)
stdResASYMP <- resid(m)/sdRES
d$Z <- stdResASYMP
# plot(fitASYMP, stdResASYMP) # same as plot(m) above
plot(d$age, stdResASYMP)
```

#### Although the tails of the empirical distribution may be a little heavy, there is no statistical evidence that the distribution of z scores is not Gaussian

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
# perhaps the distribution is a little heavy in the tails
bw <- 0.25
n_obs <- nrow(d)
ggplot(d, aes(Z))  + 
  geom_histogram(colour = "black", binwidth = bw) + 
  stat_function(fun = function(x) 
    dnorm(x, mean = mean(d$Z), sd = sd(d$Z)) * bw * n_obs)

shapiro.test(d$Z)
ks.test(d$Z, pnorm)
```
### Additional analysis without adjusting SRTs for group SC
#### To ensure that the SRT adjustment did not drastically alter the findings, we also conducted the regressions without the SRT adjustment and did this both with and without excising the one very low SRT in the SC group.


```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
dN <- getOriginalData ()
# saturated model
mSAT <- nls(SRT ~ TwoLinesFCT(age, slope1, slope2, int1, brk),
            start=list(slope1=-1.4, slope2=0.01, int1=4, brk=10),
            data=dN,
            trace = FALSE)
summary(mSAT)

mASYMP <- nls(SRT ~ TwoLinesFCT(age, slope1, 0, int1, brk),
              start=list(slope1=-1, int1=0, brk=10),
              data=dN,
              trace = FALSE)
summary(mASYMP)

# slope of upper line ~ 0, p=0.03
anova(mSAT, mASYMP)

```

#### Leaving all points in (e.g. including the outlier) resulted in the slope of the upper segment *increasing* (p = 0.041), which makes no sense, as this would suggest perceptual abilities decline in the late teens/early twenties. This model is therefore not considered further.

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
dN <- getOriginalData ()

# saturated model
mSAT <- nls(SRT ~ TwoLinesFCT(age, slope1, slope2, int1, brk),
            start=list(slope1=-1.4, slope2=0.01, int1=4, brk=10),
            data=dN,
            trace = FALSE)
summary(mSAT)

mASYMP <- nls(SRT ~ TwoLinesFCT(age, slope1, 0, int1, brk),
              start=list(slope1=-1, int1=0, brk=10),
              data=dN,
              trace = FALSE)
summary(mASYMP)
# slope of upper line ~ 0, p=0.03
anova(mSAT, mASYMP)
```

#### However, deleting that one rogue point (a  very low SRT in SC) makes it reasonable to assume a zero slope for the upper segment on the unadjusted data. The slope of the lower segment changes slightly compared to the original fit (from -1.36 to -1.41) as does the breakpoint (from 9.9 to 10.3).

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
# delete SC lowest value as < -3 s.d. from the mean = -17.13
dNx <- dN[!dN$SRT< -16,]
# saturated model
mSATx <- nls(SRT ~ TwoLinesFCT(age, slope1, slope2, int1, brk),
            start=list(slope1=-1.4, slope2=0.01, int1=4, brk=10),
            data=dNx,
            trace = FALSE)
summary(mSATx)

mASYMPx <- nls(SRT ~ TwoLinesFCT(age, slope1, 0, int1, brk),
              start=list(slope1=-1, int1=0, brk=10),
              data=dNx,
              trace = FALSE)
summary(mASYMPx)
# slope of upper line ~ 0, p=0.2
anova(mSATx, mASYMPx)

```

### Here are the 3 fits (the original, unadjusted with outlier, unadjusted without outlier), with the red line being the original.

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

TwoSlopingLines <- function(age) {
  TwoLinesFCT(age, as.numeric(coefficients(mSAT)[1]), as.numeric(coefficients(mSAT)[2]),
                   as.numeric(coefficients(mSAT)[3]), as.numeric(coefficients(mSAT)[4]))}
TwoLinesN <- function(age) {
  TwoLinesFCT(age, as.numeric(coefficients(mASYMPx)[1]), 0, as.numeric(coefficients(mASYMPx)[2]), 
               as.numeric(coefficients(mASYMPx)[3]))}
p <- ggplot(dN, aes(age, SRT, group=study, color=study)) + geom_point() 
p + stat_function(fun = TwoSlopingLines, color="black") + 
  stat_function(fun = TwoLinesN, color="black") + 
  stat_function(fun = TwoLines, color="red") 
  
```

#### As expected, the model fit to the unadjusted data is not quite as good. But the standardised residuals again look sufficiently unstructured. 

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  

plot(nlsResiduals(mASYMPx))
# summary(mASYMPx)

```

#### Although the following graph hints that the youngest children might be more dispersed, the z-scores seem reasonably constant across age:

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
resASYMPx <- resid(mASYMPx)
fitASYMPx <- fitted(mASYMPx)
sdRESx <- sd(resASYMPx)
stdResASYMPx <- resid(mASYMPx)/sdRESx
dNx$Zx <- stdResASYMPx
# plot(fitASYMP, stdResASYMP) # same as plot(m) above
plot(dNx$age, stdResASYMPx)
```

#### Although the tails of the empirical distribution may be a little heavy, there is no statistical evidence that the distribution of z scores is not Gaussian

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}  
# perhaps the distribution is a little heavy in the tails
bw <- 0.25
n_obs <- nrow(dNx)
ggplot(dNx, aes(Zx))  + 
  geom_histogram(colour = "black", binwidth = bw) + 
  stat_function(fun = function(x) 
    dnorm(x, mean = mean(dNx$Zx), sd = sd(dNx$Zx)) * bw * n_obs)

shapiro.test(dNx$Zx)
ks.test(dNx$Zx, pnorm)
```

### A direct comparison of the z-scores calculated by the two methods (with and without adjustment excluding the outlier). The black line is a diagonal showing equal z-scores by the two analyses.
#### Although confusing at first, this display shows that listeners in group SC have their z-scores improved in the newer analysis, because they were adjusted upwards by 2.4 dB in the original analysis.

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}
d %>% select(!zSRT) %>% 
  full_join(dNx) %>%
  ggplot(aes(Z,Zx)) + geom_point(aes(colour=study)) + geom_abline(slope=1, intercept = 0) +
  xlab("z-score: original analysis") + ylab("z-score: new analysis") +
  theme(axis.title = element_text(size=15))

```

#### Now, an indication of  whether the listener was > 10.33 y.o. or not shows that the z-scores for younger children are hardly changed, but older participants in the other studies exhibit worse z-scores because the SRTs for adults on average in the new norming have been lowered by group SC.



```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}
# Add an indicator for listeners > 10.33
d$matured <- d$age > 10.33
d %>% select(!zSRT) %>% 
  full_join(dNx) %>%
  ggplot(aes(Z,Zx)) + geom_point(aes(colour=matured)) + geom_abline(slope=1, intercept = 0) +
  xlab("z-score: original analysis") + ylab("z-score: new analysis") +
  theme(axis.title = element_text(size=15))

```

## Final remarks
### Plotting the z-scores as a function of age for the two methods, indicating group. Of course, group SC is much more in line with the rest of the data in the original analysis.

```{r, warning=FALSE, message=FALSE, fig.align="center",fig.height = 5, fig.width = 6,cache=TRUE}
ggplot(d, aes(age, Z, group=study, color=study)) + geom_point(size=3) +
  ylab("z-score: original analysis") + ylim(-3,3.2) +
  theme(axis.title = element_text(size=15))

ggplot(dNx, aes(age, Zx, group=study, color=study)) + geom_point(size=3) +
  ylab("z-score: new analysis") + ylim(-3,3.2) +
theme(axis.title = element_text(size=15))
```



